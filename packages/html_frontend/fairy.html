<body>
    <h1>Fairy, station! 123</h1>

    <script>
            (() => {
            const ws = new WebSocket('ws://localhost:5866/echo')
            ws.onopen = () => {
                console.log('ws opened on browser')
                ws.send('hello world')
            }

            ws.onmessage = (message) => {
                console.log(`message received ${message}`)
            }

            })()

        addCount = async () => {
            let accounts = await web3.eth.getAccounts();
            await contract.methods.addCount().send({
                from: accounts[0]
            })
            $('#count').text(await contract.methods.getCount().call())
        }

        setText = async () => {
            let mesg = $('#input').val()

            let accounts = await web3.eth.getAccounts();
            await contract.methods.setHello(mesg).send({
                from: accounts[0]
            })
            // $('#message').text(await contract.methods.getHello().call())
        }

        resetCount = async () => {
            let accounts = await web3.eth.getAccounts();
            await contract.methods.resetCount().send({
                from: accounts[0]
            })
            $('#count').text(await contract.methods.getCount().call()) 
        }


    </script>

<button id="auth">authentication through metamask</button>
<button id="sign" style="display: none">sign</button>
<button id="consenseService" style="display: none">Consense Service</button>
<h2 id="status"></h2>
<h4 id="message"></h4>
<h4 id="applist"></h4>

<script>
const $authButton = document.querySelector('#auth');
const $statusText = document.querySelector('#status');
const $signButton = document.querySelector('#sign');
const $consenseServiceButton = document.querySelector('#consenseService');
let provider;

$authButton.addEventListener('click', () => {
  if (typeof window.ethereum !== 'undefined' || (typeof window.web3 !== 'undefined')) {
    provider = window['ethereum'] || window.web3.currentProvider;
    if (provider.isMetaMask) {
        provider.autoRefreshOnNetworkChange = false;
        provider.enable()
        .then(accounts => {
          $statusText.innerText = `authorized with account: ${accounts[0]}`;
          $authButton.style.display = 'none';
          $signButton.style.display = 'block';
          $consenseServiceButton.style.display = 'block';
        })
        .catch(error => {
          console.error(error);
        });
    }
    else $statusText.innerText = 'it\'s not a metamask!';
  }
  else $statusText.innerText = 'need enable metamask!';
});

$signButton.addEventListener('click', () => {
  provider.sendAsync({
    method: 'personal_sign',
    params: [
      // in node.js `0x${new Buffer('example', 'utf8').toString('hex')}`
      // or in browser https://stackoverflow.com/a/57747142/2823865
      '0x6578616d706c65',
      provider.selectedAddress
    ],
    from: provider.selectedAddress,
  }, (error, result) => {
    if ( ! error) {
      result = result.result;
      $statusText.innerText = `signed! result: ${result}`;
    } else {
      if (error.code == -32603) $statusText.innerText = 'decline sign!';
      else console.error(error);
    }
  });
});

$consenseServiceButton.addEventListener('click', async() => {
    fetch('./fairy.json')
    //.then(response => response.json())
    .then(response => response.text())
    .then(async(data) => {
    //.then(async(response) => {
        let contractAddress = '0x6bD4cDB79335b661A7FCFAAD8566D206Ae66AE0c'
        let web
        if (typeof window.ethereum !== 'undefined') {
            web3 = new Web3(provider);
            const abi = JSON.parse(data);

            const contract = new web3.eth.Contract(abi.abi, contractAddress)
            let mintResult = await contract.methods.mint('fairy.html').call()
            let appListResult = await contract.methods.getAppList().call()
            $('#message').text(mintResult)
            $('#applist').text(appListResult)
        } else {
            console.log('Not support eth')
        }
    });
});
</script>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
        integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
        integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.3.0/web3.min.js"></script>
</body>